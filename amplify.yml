version: 1
backend:
  phases:
    preBuild:
      commands:
        - sudo yum install -y jq
        - sudo yum install -y docker
        - sudo nohup dockerd &
        - sleep 20
        - sudo chmod 666 /var/run/docker.sock
        - cd cdk
        - python3 -m venv .venv
        - source .venv/bin/activate
        - pip install -r requirements.txt
        - npm install -g aws-cdk
    build:
      commands:
        - cdk bootstrap || true
        - cdk synth
        - cdk deploy --all --require-approval never --outputs-file ../frontend/cdk-outputs.json
        - cd ..
  artifacts:
    baseDirectory: cdk/cdk.out
    files:
      - '**/*'
  cache:
    paths:
      - cdk/.venv/**/*
frontend:
  phases:
    preBuild:
      commands:
        - cd frontend
        # Print cdk-outposts file
        - cat cdk-outputs.json
        - npm ci --legacy-peer-deps
        # Extract values using pattern matching
        - |
          export API_ENDPOINT=$(jq -r '.AmplifyMainBackendStack | to_entries[] | select(.key | startswith("ApiGatewayRestApiEndpoint")).value' cdk-outputs.json)
          export WORKORDER_API_ENDPOINT=$(jq -r '.AmplifyMainBackendStack | to_entries[] | select(.key | startswith("WorkOrderApiGatewayRestApiEndpoint")).value' cdk-outputs.json)
          export COGNITO_USER_POOL_ID=$(jq -r '.AmplifyMainBackendStack | to_entries[] | select(.key | startswith("CognitoUserPoolId")).value' cdk-outputs.json)
          export COGNITO_USER_POOL_CLIENT_ID=$(jq -r '.AmplifyMainBackendStack | to_entries[] | select(.key | startswith("CognitoUserPoolClientId")).value' cdk-outputs.json)
          export COGNITO_IDENTITY_POOL_ID=$(jq -r '.AmplifyMainBackendStack | to_entries[] | select(.key | startswith("CognitoIdentityPoolId")).value' cdk-outputs.json)
          export REGION_NAME=$(jq -r '.AmplifyMainBackendStack.RegionName' cdk-outputs.json)
    build:
      commands:
        - |
          cat << EOF > .env
          VITE_API_ENDPOINT="${API_ENDPOINT}"
          VITE_WORKORDER_API_ENDPOINT="${WORKORDER_API_ENDPOINT}"
          VITE_REGION_NAME="${REGION_NAME}"
          VITE_COGNITO_USER_POOL_ID="${COGNITO_USER_POOL_ID}"
          VITE_COGNITO_USER_POOL_CLIENT_ID="${COGNITO_USER_POOL_CLIENT_ID}"
          VITE_COGNITO_IDENTITY_POOL_ID="${COGNITO_IDENTITY_POOL_ID}"
          VITE_API_NAME="RestAPI"
          VITE_APP_NAME="Field Workforce safety assistant"
          VITE_WorkOrder_API_NAME="WorkOrderAPI"
          VITE_PROTOTYPE_NAME="WorkOrderSafetyDemo"
          VITE_COGNITO_DOMAIN=".auth.us-east-1.amazoncognito.com/"
          EOF
        # Print generated .env file
        - echo "Generated .env file:"
        - cat .env
        - npm run build
  artifacts:
    baseDirectory: frontend/dist
    files:
      - '**/*'
  cache:
    paths:
      - frontend/node_modules/**/*
      - .npm/**/*